<!Doctype html>
{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}
{% load custom_tags %}

{% block titleBlock %}
    <title>Pre Election Portal</title>
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <link href="//netdna.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet" id="bootstrap-css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/summernote/0.8.9/summernote-lite.css" rel="stylesheet">
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="//code.jquery.com/jquery-1.11.1.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
    <script src="//netdna.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
    <script src="https://kit.fontawesome.com/3fb32c2b41.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/summernote/0.8.9/summernote-lite.js"></script>
    <script>
        {% block jqueryBlock %}
            function updateVoteCount(span, upvotes, downvotes, upvoteColor, downvoteColor) {
                console.log(span.children());
                span.children().children().attr("data-upvote", upvotes);
                span.children().children().attr("data-downvote", downvotes);
                span.children(".text-vote").text(upvotes-downvotes);
                span.children("span:nth-child(1)").children().children().css("color", upvoteColor);
                span.children("span:nth-child(3)").children().children().css("color", downvoteColor);
                console.log(upvoteColor, downvoteColor)
            }

            $("body").on('click', '.btn-upvote', function (e) {
                e.preventDefault();
                const this_ = $(this);
                const upvoteUrl = this_.attr("data-href");
                const upvoteCount = parseInt(this_.attr("data-upvote"));
                const downvoteCount = parseInt(this_.attr("data-downvote"));
                $.ajax({
                    url: upvoteUrl,
                    method: "GET",
                    data: {},
                    success: function (data) {
                        console.log(data);
                        const newUpvotes = upvoteCount + data.upvote;
                        const newDownvotes = downvoteCount + data.downvote;
                        updateVoteCount(this_.parent().parent(), newUpvotes, newDownvotes, data.upvoteColor, data.downvoteColor);
                    },
                    error: function (error) {
                        console.log("error");
                        console.log(error);
                    }
                });
            });

            $("body").on('click', '.btn-downvote', function (e) {
                const this_ = $(this);
                const downvoteUrl = this_.attr("data-href");
                const upvoteCount = parseInt(this_.attr("data-upvote"));
                const downvoteCount = parseInt(this_.attr("data-downvote"));
                $.ajax({
                    url: downvoteUrl,
                    method: "GET",
                    data: {},
                    success: function (data) {
                        console.log(data);
                        const newUpvotes = upvoteCount + data.upvote;
                        const newDownvotes = downvoteCount + data.downvote;
                        updateVoteCount(this_.parent().parent(), newUpvotes, newDownvotes, data.upvoteColor, data.downvoteColor);
                    },
                    error: function (error) {
                        console.log("error");
                        console.log(error);
                    }
                });
            });

            $("#id_position").change(function (e) {
                const url = $("#question-form").attr("data-href");
                const position = $(this).val();

                $.ajax({
                    url: url,
                    data: {
                        'position': position
                    },
                    success: function (data) {
                        $("#id_asked_to").html(data);
                    }
                });
            });

            $(".btn-approve").click(function (e) {
                e.preventDefault();
                const this_ = $(this);
                const approveUrl = this_.attr("data-href");
                $.ajax({
                    url: approveUrl,
                    method: "GET",
                    data: {},
                    success: function (data) {
                        this_.text("Approved");
                    },
                    error: function (error) {
                        console.log("error");
                        console.log(error);
                        alert("Error in approving");
                    }
                });
            });

            $(".btn-delete").click(function (e) {
                e.preventDefault();
                const this_ = $(this);
                const deleteUrl = this_.attr("data-href");
                $.ajax({
                    url: deleteUrl,
                    method: "GET",
                    data: {},
                    success: function (data) {
                        this_.text("Deleted");
                    },
                    error: function (error) {
                        console.log("error");
                        console.log(error);
                        alert("Error in Deleting");
                    }
                });
            });

            $(".btn-sort-recent").click(function (e) {
                e.preventDefault();
                const this_ = $(this);
                const sort_by = "-asked_on";
                const sort_on = this_.attr("data-sort-on");
                const user = this_.attr("data-user");
                $.ajax({
                    type: "GET",
                    url: "{% url 'portal:api-sort' %}",
                    data: {
                        'sort_by': sort_by,
                        'sort_on': sort_on,
                        'user': user,
                    }
                }).done(function (data) {
                    this_.parent().parent().children(".container-questions").html(data.html_questions);
                    this_.css("border-style", "inset");
                    this_.parent().children(".btn-sort-upvotes").css("border-style", 'outset');
                });
            });

            $(".btn-sort-upvotes").click(function (e) {
                e.preventDefault();
                const this_ = $(this);
                const sort_by = "upvotes";
                const sort_on = this_.attr("data-sort-on");
                const user = this_.attr("data-user");
                $.ajax({
                    type: "GET",
                    url: "{% url 'portal:api-sort' %}",
                    data: {
                        'sort_by': sort_by,
                        'sort_on': sort_on,
                        'user': user,
                    }
                }).done(function (data) {
                    this_.parent().parent().children(".container-questions").html(data.html_questions);
                    this_.css("border-style", "inset");
                    this_.parent().children(".btn-sort-recent").css("border-style", 'outset');
                });
            });

            $("body").on('click', '.toggle-comment', function (e) {
                e.preventDefault();
                $(this).parent().children(".comments").toggle("1000");
            });
        {% endblock %}
    </script>
{% endblock %}

{% block bodyBlock %}

    {% if unapproved_questions %}
        {% for question in unapproved_questions %}
            <div class="card border-dark m-3">
                <div class="card-header">
                    <p><strong>{{ question.question }}</strong></p>
                </div>
                <div class="card-body">
                    <span><button class="btn-approve" data-href="{% url 'portal:api-approve' question.pk  %}" >Approve</button><button class="btn-delete" data-href="{% url 'portal:api-delete-question' question.pk  %}" >Delete</button></span>
                </div>
            </div>
        {% endfor %}
    {% endif %}

    {% if unapproved_comments %}
        {% for comment in unapproved_comments %}
            <div class="card border-dark m-3">
                <div class="card-header">
                    <p><strong>{{ comment.question.question }}</strong></p>
                </div>
                <div class="card-body">
                    <p><i>{{ comment.comment|safe }}</i></p>
                    <span><button class="btn-approve" data-href="{% url 'portal:api-approve-comment' comment.pk  %}" >Approve</button><button class="btn-delete" data-href="{% url 'portal:api-delete-comment' comment.pk  %}" >Delete</button></span>
                </div>
            </div>
        {% endfor %}
    {% endif %}

    {% if my_questions %}
        <div class="container-questions-static">
            <span id="my-questions-sort-tray" class="sort-tray ml-3">
                <button class="btn-sort-recent" type="button" data-sort-on="my-questions" data-user="{{ user }}" style="border-style: inset">Recent</button>
                <button class="btn-sort-upvotes" type="button" data-sort-on="my-questions" data-user="{{ user }}" style="border-style: outset">Upvotes</button>
            </span>

            <div class="container-questions">
                {% for question in my_questions  %}
                    <div class="card border-dark m-3">
                        <div class="card-header">
                            <strong>{{ question.question | safe }}</strong>
                        </div>
                        <div class="card-body">
                            <div class="card-text">
                                <div class="text-muted">
                                    <strong>Asked to {{ question.asked_to }}</strong>
                                </div>
                                <p><small class="text-muted">Asked by {{ question.asked_by }} on {{ question.asked_on }}</small></p>
                            </div>

                            {% if question.answered %}
                                <p>{{ question.answer|safe }}</p>
                            {% endif %}

                            {% if question.answered %}
                                <a class="btn btn-primary" href="{% url 'portal:answer' question.pk %}">Update</a>
                            {% else %}
                                <a class="btn btn-primary" href="{% url 'portal:answer' question.pk %}">Answer</a>
                            {% endif %}

                            <span class="vote-tray">
                                {% if user in question.upvotes.all %}
                                    <span><a class="btn-upvote" data-upvote="{{ question.upvotes.count }}" data-downvote="{{ question.downvotes.count }}" data-href="{{ question.get_upvote_api_url }}" ><i style="color: blue" class="far fa-thumbs-up"></i></a></span>
                                {% else %}
                                    <span><a class="btn-upvote" data-upvote="{{ question.upvotes.count }}" data-downvote="{{ question.downvotes.count }}" data-href="{{ question.get_upvote_api_url }}" ><i class="far fa-thumbs-up"></i></a></span>
                                {% endif %}
                                <span class="text-vote">{{ question.upvotes.count }}</span>
                            </span>
                            <span class="toggle-comment"><i class="fas fa-comment"></i></span>

                            <div class="comments" style="display: none">
                                {% if comment_form %}
                                    <form method="post" action="{% url 'portal:comment' question.pk %}">
                                        {% csrf_token %}
                                        {{ comment_form.as_p }}
        {#                                <button type="submit">Submit</button>#}
                                    </form>
                                {% endif %}
                                {% if question.comments.count != 0%}
                                    <div class="ml-5">
                                        <br>
                                        {% for comment in question.comments.all  %}
                                            {% if comment.approved %}
                                                <strong><p>{{ comment.comment_by }}</p></strong>
                                                <p><i>{{ comment.comment|safe }}</i></p>

                                                <span class="vote-tray">
                                                    {% if user in comment.upvotes.all %}
                                                        <span><a class="btn-upvote" data-upvote="{{ comment.upvotes.count }}" data-downvote="{{ comment.downvotes.count }}" data-href="{{ comment.get_upvote_api_url }}" ><i style="color: blue" class="far fa-thumbs-up"></i></a></span>
                                                    {% else %}
                                                        <span><a class="btn-upvote" data-upvote="{{ comment.upvotes.count }}" data-downvote="{{ comment.downvotes.count }}" data-href="{{ comment.get_upvote_api_url }}" ><i class="far fa-thumbs-up"></i></a></span>
                                                    {% endif %}
                                                    <span class="text-vote">{{ comment.upvotes.count|subtract:comment.downvotes.count }}</span>
                                                    {% if user in comment.downvotes.all %}
                                                        <span><a class="btn-downvote" data-upvote="{{ comment.upvotes.count }}" data-downvote="{{ comment.downvotes.count }}" data-href="{{ comment.get_downvote_api_url }}"><i style="color: red" class="far fa-thumbs-down"></i></a></span>
                                                    {% else %}
                                                        <span><a class="btn-downvote" data-upvote="{{ comment.upvotes.count }}" data-downvote="{{ comment.downvotes.count }}" data-href="{{ comment.get_downvote_api_url }}"><i class="far fa-thumbs-down"></i></a></span>
                                                    {% endif %}
                                                </span>
                                            {% endif %}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>

                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>

    {% endif %}

    {% if approved_questions %}
        <div class="container-questions-static">
            <span id="approved-sort-tray" class="sort-tray ml-3">
                <button class="btn-sort-recent" type="button" data-sort-on="approved" data-user="{{ user }}" style="border-style: inset">Recent</button>
                <button class="btn-sort-upvotes" type="button" data-sort-on="approved" data-user="{{ user }}" style="border-style: outset">Upvotes</button>
            </span>

            <div class="container-questions">
                {% for question in approved_questions %}
                    <div class="card border-dark m-3">
                        <div class="card-header">
                            <strong>{{ question.question }}</strong>
                        </div>
                        <div class="card-body">
                            <div class="card-text">
                                <div class="text-muted">
                                    <strong>Asked to {{ question.asked_to }}</strong>
                                </div>
                                <p><small class="text-muted">Asked by {{ question.asked_by }} on {{ question.asked_on }}</small></p>
                            </div>
                            {% if question.answered %}
                                <div class="card-text">
                                    {{ question.answer|safe }}
                                </div>
                            {% endif %}
                            <span class="vote-tray">
                                {% if user in question.upvotes.all %}
                                    <span><a class="btn-upvote" data-upvote="{{ question.upvotes.count }}" data-downvote="{{ question.downvotes.count }}" data-href="{{ question.get_upvote_api_url }}" ><i style="color: blue" class="far fa-thumbs-up"></i></a></span>
                                {% else %}
                                    <span><a class="btn-upvote" data-upvote="{{ question.upvotes.count }}" data-downvote="{{ question.downvotes.count }}" data-href="{{ question.get_upvote_api_url }}" ><i class="far fa-thumbs-up"></i></a></span>
                                {% endif %}
                                <span class="text-vote">{{ question.upvotes.count }}</span>
                            </span>
                            <span class="toggle-comment"><i class="fas fa-comment"></i></span>

                            <div class="comments" style="display: none">
                                {% if comment_form %}
                                    <form method="post" action="{% url 'portal:comment' question.pk %}">
                                        {% csrf_token %}
                                        {{ comment_form.as_p }}
        {#                                <button type="submit">Submit</button>#}
                                    </form>
                                {% endif %}
                                {% if question.comments.count != 0%}
                                    <div class="ml-5">
                                        <br>
                                        {% for comment in question.comments.all  %}
                                            {% if comment.approved %}
                                                <strong><p>{{ comment.comment_by }}</p></strong>
                                                <p><i>{{ comment.comment|safe }}</i></p>

                                                <span class="vote-tray">
                                                    {% if user in comment.upvotes.all %}
                                                        <span><a class="btn-upvote" data-upvote="{{ comment.upvotes.count }}" data-downvote="{{ comment.downvotes.count }}" data-href="{{ comment.get_upvote_api_url }}" ><i style="color: blue" class="far fa-thumbs-up"></i></a></span>
                                                    {% else %}
                                                        <span><a class="btn-upvote" data-upvote="{{ comment.upvotes.count }}" data-downvote="{{ comment.downvotes.count }}" data-href="{{ comment.get_upvote_api_url }}" ><i class="far fa-thumbs-up"></i></a></span>
                                                    {% endif %}
                                                    <span class="text-vote">{{ comment.upvotes.count|subtract:comment.downvotes.count }}</span>
                                                    {% if user in comment.downvotes.all %}
                                                        <span><a class="btn-downvote" data-upvote="{{ comment.upvotes.count }}" data-downvote="{{ comment.downvotes.count }}" data-href="{{ comment.get_downvote_api_url }}"><i style="color: red" class="far fa-thumbs-down"></i></a></span>
                                                    {% else %}
                                                        <span><a class="btn-downvote" data-upvote="{{ comment.upvotes.count }}" data-downvote="{{ comment.downvotes.count }}" data-href="{{ comment.get_downvote_api_url }}"><i class="far fa-thumbs-down"></i></a></span>
                                                    {% endif %}
                                                </span>
                                            {% endif %}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            <br>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>
    {% endif %}


    <div class="card border-dark m-3">
        <div class="card-header border-dark">
            <strong>Ask Me Anything</strong>
        </div>
        <form id="question-form" class="form-group" action="{% url 'portal:index' %}" method="post" data-href="{% url 'portal:ajax-load-candidates' %}">
            <div class="card-body">
                {% if question_form %}
                    {% csrf_token %}
                    {{ question_form.question | as_crispy_field }}
                    <div class="row">
                        <div class="col-6">
                            {{ question_form.position | as_crispy_field }}
                        </div>
                        <div class="col-6">
                            {{ question_form.asked_to | as_crispy_field }}
                        </div>
                    </div>
                {% endif %}
            </div>
            <div class="card-footer">
                <input class="btn btn-primary btn-rounded" type="submit" name="Ask" value="Ask">
            </div>
        </form>
    </div>
{% endblock %}